<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>مدير الفيديوهات</title>

  <!-- أيقونة التبويب -->
  <link rel="icon" type="image/png" href="../assets/app_icon.png" />
  <link rel="apple-touch-icon" href="../assets/app_icon.png" />

  <style>
    :root{
      --bg:#0b1220;
      --card:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --line:rgba(148,163,184,.18);
      --primary:#ffffff;
      --primaryText:#0b1220;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius:18px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 80% -10%, rgba(56,189,248,.22), transparent 60%),
                  radial-gradient(1200px 700px at 10% 10%, rgba(167,139,250,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:system-ui,Segoe UI,Tahoma,Arial;
      line-height:1.7;
    }

    .wrap{max-width:980px;margin:34px auto;padding:0 16px}

    .header{
      display:flex;align-items:flex-start;justify-content:space-between;gap:16px;
      margin-bottom:18px;
    }

    .brand{display:flex;align-items:center;gap:14px}
    .logo{
      width:56px;height:56px;border-radius:16px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      display:flex;align-items:center;justify-content:center;
      box-shadow: var(--shadow);
      overflow:hidden;
      flex:0 0 auto;
    }
    .logo img{width:100%;height:100%;object-fit:cover}

    h1{margin:0;font-size:26px;letter-spacing:.2px}
    .sub{color:var(--muted);max-width:620px;font-size:14.5px;margin-top:4px}

    .pill{
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      box-shadow:0 10px 30px rgba(0,0,0,.25);
      user-select:none;
      white-space:nowrap;
      margin-top:2px;
    }
    .dot{
      width:10px;height:10px;border-radius:99px;background:rgba(148,163,184,.95);
      box-shadow:0 0 0 4px rgba(148,163,184,.18);
    }

    .grid{display:grid;grid-template-columns:1.4fr .9fr;gap:16px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} .pill{justify-content:flex-start} .header{flex-direction:column} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
    }

    h2{margin:0 0 10px;font-size:18px}
    p{margin:0 0 12px;color:var(--text)}
    .muted{color:var(--muted)}
    .small{font-size:13px}

    .actions{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0 6px}
    a.btn{
      display:inline-flex;align-items:center;gap:10px;
      padding:12px 14px;border-radius:14px;
      text-decoration:none;
      border:1px solid rgba(255,255,255,.16);
      color:var(--text);
      background:rgba(255,255,255,.05);
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
    }
    a.btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.22)}
    a.btn.primary{
      background:var(--primary);
      color:var(--primaryText);
      border-color:rgba(255,255,255,.40);
      font-weight:700;
    }
    a.btn.primary:hover{background:#f8fafc}

    a.btn.ghost{background:transparent}

    .ico{width:18px;height:18px;display:inline-flex}
    .ico svg{width:18px;height:18px}

    .status{
      margin:10px 0 0;
      padding:10px 12px;border-radius:14px;
      background:rgba(2,6,23,.35);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
    }

    .note{
      margin-top:12px;
      padding:12px 12px;border-radius:14px;
      background:rgba(2,6,23,.35);
      border:1px solid rgba(255,255,255,.10);
      color:var(--muted);
      font-size:13.5px;
    }
    .kbd{
      display:inline-flex;align-items:center;
      padding:3px 8px;border-radius:10px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-size:12.5px;
      margin:0;
    }

    .list{list-style:none;padding:0;margin:10px 0 0;display:flex;flex-direction:column;gap:10px}
    .list li{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:12px;border-radius:16px;
      background:rgba(2,6,23,.28);
      border:1px solid rgba(255,255,255,.10);
    }
    .title{font-weight:700}
    .meta{color:var(--muted);font-size:12.5px;margin-top:2px}

    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .right a.btn{padding:10px 12px;border-radius:12px}

    .device-info{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:8px;
    }
    .device-row{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .device-row .ua{
      word-break:break-word;
    }

    /* ✅ شارة عدد التنزيلات بجانب كل نسخة */
    .dl-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--muted);
      font-size:12.5px;
      white-space:nowrap;
    }

    /* ✅ إصدار + إجمالي التنزيلات داخل نفس مربع الإصدار */
    .release-wrap{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .release-left{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .release-right{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .badge-soft{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      font-size:12.5px;
      white-space:nowrap;
    }
    .badge-soft .muted{ color:var(--muted); }
    .badge-soft .num{
      font-weight:800;
      letter-spacing:.2px;
      color:var(--text);
    }
    .badge-soft .mini-dot{
      width:8px;height:8px;border-radius:999px;
      background:rgba(34,197,94,.95);
      box-shadow:0 0 0 4px rgba(34,197,94,.18);
    }

    footer{
      margin:18px 0 8px;
      color:var(--muted);
      font-size:12.5px;
      text-align:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <img src="../assets/app_icon.png" alt="App Icon">
        </div>
        <div>
          <h1>مدير الفيديوهات</h1>
          <div class="sub">
            صفحة رسمية لتنزيل آخر إصدار. زر ذكي يرشّح النسخة المناسبة لجهازك، مع روابط مباشرة لكل المعماريات.
          </div>

          <!-- زر رجوع للمعرض -->
          <div class="actions" style="margin-top:10px">
            <a class="btn ghost" href="https://abood202.github.io/my-app-site/">رجوع للمعرض</a>
          </div>
        </div>
      </div>

      <div class="pill" id="envPill" title="كشف البيئة">
        <span class="dot" id="envDot"></span>
        <span id="envText">جارٍ التعرف على جهازك…</span>
      </div>
    </div>

    <div class="grid">
      <section class="card" aria-label="تنزيل">
        <h2>آخر إصدار</h2>
        <p>
          اضغط على <b>التنزيل الذكي</b> وسيتم ترشيح النسخة الأقرب لجهازك. إذا لم ينجح الكشف، استخدم الروابط اليدوية.
        </p>

        <!-- ✅ مربع الإصدار + إجمالي التنزيلات -->
        <div class="status" id="releaseInfo" style="margin-top:10px">
          <div class="release-wrap">
            <div class="release-left">
              <span class="muted">الإصدار:</span>
              <b id="relTag">جارٍ جلب آخر إصدار…</b>
            </div>

            <div class="release-right">
              <span class="badge-soft" title="إجمالي تنزيلات ملفات APK داخل آخر Release">
                <span class="mini-dot" aria-hidden="true"></span>
                <span class="muted">إجمالي التنزيلات</span>
                <span class="num" id="totalDownloads">—</span>
              </span>
            </div>
          </div>

          <div class="muted small" id="relNote" style="margin-top:6px; display:none"></div>
        </div>

        <div class="actions">
          <a class="btn primary" href="#" id="smartBtn">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M12 3v10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M7 10l5 5 5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M5 21h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </span>
            تنزيل النسخة المناسبة لجهازي
          </a>

          <a class="btn ghost" href="#manual">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M4 6h16M4 12h16M4 18h16" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </span>
            عرض كل النسخ
          </a>
        </div>

        <div class="status" id="smartStatus">
          <span class="muted">الحالة:</span> جاهز.
        </div>

        <div class="note">
          <b>مهم:</b> على أندرويد قد تحتاج لتفعيل <span class="kbd">Install unknown apps</span> أو
          <span class="kbd">مصادر غير معروفة</span> من إعدادات الجهاز قبل التثبيت.
        </div>

        <div id="manual" style="height:12px"></div>
        <h2 style="margin-top:8px">التحميل اليدوي</h2>

        <ul class="list" aria-label="روابط التحميل">
          <li>
            <div>
              <div class="title">arm64-v8a <span class="meta">— الموصى بها لمعظم الأجهزة الحديثة</span></div>
              <div class="meta">Android 64-bit (ARM)</div>
            </div>
            <div class="right">
              <span class="dl-badge" title="تنزيلات هذه النسخة">
                <span class="muted">تنزيلات:</span>
                <b id="dlArm64">—</b>
              </span>
              <a class="btn" id="btnArm64" href="#">تنزيل</a>
            </div>
          </li>

          <li>
            <div>
              <div class="title">armeabi-v7a <span class="meta">— للأجهزة الأقدم</span></div>
              <div class="meta">Android 32-bit (ARM)</div>
            </div>
            <div class="right">
              <span class="dl-badge" title="تنزيلات هذه النسخة">
                <span class="muted">تنزيلات:</span>
                <b id="dlV7a">—</b>
              </span>
              <a class="btn" id="btnV7a" href="#">تنزيل</a>
            </div>
          </li>

          <li>
            <div>
              <div class="title">x86_64 <span class="meta">— غالبًا للمحاكيات</span></div>
              <div class="meta">Android Emulator / Intel</div>
            </div>
            <div class="right">
              <span class="dl-badge" title="تنزيلات هذه النسخة">
                <span class="muted">تنزيلات:</span>
                <b id="dlX86">—</b>
              </span>
              <a class="btn" id="btnX86" href="#">تنزيل</a>
            </div>
          </li>
        </ul>
      </section>

      <aside class="card" aria-label="الدعم والملاحظات">
        <h2>اقتراحات وملاحظات</h2>
        <p>
          لديك اقتراح أو واجهت مشكلة؟ استخدم صفحة الـ Issues وسيصلني تقريرك بشكل منظم.
        </p>

        <div class="actions">
          <a class="btn" href="https://github.com/abood202/my-app-site/issues">
            <span class="ico" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M12 22s8-4 8-10V6l-8-4-8 4v6c0 6 8 10 8 10Z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                <path d="M12 11v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <path d="M12 8h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round"/>
              </svg>
            </span>
            فتح صفحة Issues
          </a>
        </div>

        <div class="note">
          <b>نصيحة:</b> عند إرسال Bug report اذكر نوع الجهاز وإصدار أندرويد وخطوات تكرار المشكلة.
        </div>

        <h2 style="margin-top:14px">معلومات جهازك</h2>
        <div class="muted small" id="deviceInfo">جارٍ جمع المعلومات…</div>

        <div class="note">
          إن لم يتم التعرف على المعمارية بدقة (ABI)، ستبقى الروابط اليدوية هي الخيار الآمن.
        </div>
      </aside>
    </div>

    <footer>© صفحة تنزيل التطبيق — مُستضافة عبر GitHub</footer>
  </div>

  <script>
    // ✅ إعدادات GitHub Repo لجلب أرقام التنزيلات + روابط آخر Release
    const GH = { owner: "abood202", repo: "my-app-site" };

    // ✅ روابط احتياطية (تُستخدم لو فشل GitHub API)
    const APK = {
      arm64:  "https://github.com/abood202/my-app-site/releases/download/v1.0.0/app-arm64-v8a-release.apk",
      v7a:    "https://github.com/abood202/my-app-site/releases/download/v1.0.0/app-armeabi-v7a-release.apk",
      x86_64: "https://github.com/abood202/my-app-site/releases/download/v1.0.0/app-x86_64-release.apk",
    };

    const el = (id) => document.getElementById(id);

    function ua() { return navigator.userAgent || ""; }
    function uaLower(){ return ua().toLowerCase(); }

    function platformGuess(){
      if (navigator.userAgentData && navigator.userAgentData.platform) {
        return String(navigator.userAgentData.platform);
      }
      if (uaLower().includes("android")) return "Android";
      if (uaLower().includes("iphone") || uaLower().includes("ipad") || uaLower().includes("ios")) return "iOS";
      if (uaLower().includes("windows")) return "Windows";
      if (uaLower().includes("mac os")) return "macOS";
      if (uaLower().includes("linux")) return "Linux";
      return "Unknown";
    }

    function isAndroid(){
      const p = platformGuess().toLowerCase();
      return p.includes("android") || uaLower().includes("android");
    }

    // ترشيح ABI اعتماداً على UA (ليس 100% مؤكد)
    function guessAbi(){
      const u = uaLower();
      if (u.includes("x86_64") || (u.includes("x86") && !u.includes("arm")) || u.includes("intel")) return "x86_64";
      if (u.includes("aarch64") || u.includes("armv8") || u.includes("arm64")) return "arm64";
      if (u.includes("armv7") || u.includes("armeabi-v7a") || u.includes("armeabi")) return "v7a";
      return "arm64";
    }

    function prettyAbi(abi){
      if (abi === "arm64") return "arm64-v8a";
      if (abi === "v7a") return "armeabi-v7a";
      if (abi === "x86_64") return "x86_64";
      return "غير معروف";
    }

    function setEnvPill(){
      const platform = platformGuess();
      const android = isAndroid();

      el("envDot").style.background = android ? "rgba(34,197,94,.95)" : "rgba(239,68,68,.95)";
      el("envDot").style.boxShadow  = android ? "0 0 0 4px rgba(34,197,94,.18)" : "0 0 0 4px rgba(239,68,68,.16)";
      el("envText").textContent     = android ? `Android — جاهز للتنزيل` : `${platform} — ملفات APK لأندرويد فقط`;
    }

    function fillDeviceInfo(){
      const platform = platformGuess();
      const android  = isAndroid();
      const abi      = guessAbi();

      el("deviceInfo").innerHTML =
        `<div class="device-info">
          <div class="device-row">
            <span class="kbd">Platform</span>
            <span>${platform}</span>
          </div>

          <div class="device-row">
            <span class="kbd">Android</span>
            <span>${android ? "Yes" : "No"}</span>
          </div>

          <div class="device-row">
            <span class="kbd">ABI guess</span>
            <span>${prettyAbi(abi)}</span>
          </div>

          <div class="device-row">
            <span class="kbd">UA</span>
            <span class="ua">${ua()}</span>
          </div>
        </div>`;
    }

    function bindLinks(){
      el("btnArm64").href = APK.arm64;
      el("btnV7a").href   = APK.v7a;
      el("btnX86").href   = APK.x86_64;
    }

    function setDownloadsUI(which, count){
      const n = Number(count) || 0;
      if(which === "arm64") el("dlArm64").textContent = n.toLocaleString("ar-EG");
      if(which === "v7a")   el("dlV7a").textContent   = n.toLocaleString("ar-EG");
      if(which === "x86_64")el("dlX86").textContent   = n.toLocaleString("ar-EG");
    }

    async function loadLatestRelease(){
      try{
        const url = `https://api.github.com/repos/${GH.owner}/${GH.repo}/releases/latest`;
        const res = await fetch(url, { headers: { "Accept": "application/vnd.github+json" } });
        if(!res.ok) throw new Error("GitHub API error");

        const data = await res.json();

        // ✅ عرض التاغ
        const tag = data.tag_name || "آخر إصدار";
        el("relTag").textContent = tag;

        const assets = Array.isArray(data.assets) ? data.assets : [];

        // ✅ إجمالي التنزيلات (مجموع download_count لكل Assets في آخر Release)
        const total = assets.reduce((sum, a) => sum + (Number(a.download_count) || 0), 0);
        el("totalDownloads").textContent = total.toLocaleString("ar-EG");

        // ابحث بالاسم داخل Assets
        const findByName = (needle) =>
          assets.find(a => (a.name || "").toLowerCase() === needle.toLowerCase());

        const aArm64 = findByName("app-arm64-v8a-release.apk");
        const aV7a   = findByName("app-armeabi-v7a-release.apk");
        const aX86   = findByName("app-x86_64-release.apk");

        // لو وجدناها، نحدث الروابط + عدد التنزيلات لكل ملف
        if (aArm64){
          APK.arm64 = aArm64.browser_download_url;
          setDownloadsUI("arm64", aArm64.download_count ?? 0);
        }
        if (aV7a){
          APK.v7a = aV7a.browser_download_url;
          setDownloadsUI("v7a", aV7a.download_count ?? 0);
        }
        if (aX86){
          APK.x86_64 = aX86.browser_download_url;
          setDownloadsUI("x86_64", aX86.download_count ?? 0);
        }

        bindLinks();

        // تنبيه أنيق لو لم يجد بعض الملفات
        const missing = [];
        if(!aArm64) missing.push("arm64");
        if(!aV7a)   missing.push("v7a");
        if(!aX86)   missing.push("x86_64");

        if(missing.length){
          const note = el("relNote");
          note.style.display = "block";
          note.textContent = `ملاحظة: لم أجد بعض ملفات APK في Assets (${missing.join(", ")}). تم استخدام روابط احتياطية.`;
        }

      }catch(e){
        // فشل API: نستخدم روابط fallback ولا نكسر الصفحة
        el("relTag").textContent = "غير متاح الآن";
        el("totalDownloads").textContent = "—";

        const note = el("relNote");
        note.style.display = "block";
        note.textContent = "تعذّر جلب بيانات GitHub الآن (تم استخدام روابط احتياطية).";

        bindLinks();
      }
    }

    function smartDownload(e){
      e.preventDefault();

      const status  = el("smartStatus");
      const android = isAndroid();
      const abi     = guessAbi();

      if (!android){
        status.innerHTML = `<span class="muted">الحالة:</span> هذا الجهاز ليس Android. استخدم جهاز أندرويد للتثبيت.`;
        return;
      }

      const pick = APK[abi] ? abi : "arm64";
      status.innerHTML = `<span class="muted">الحالة:</span> تم ترشيح <b>${prettyAbi(pick)}</b> وسيبدأ التنزيل الآن…`;
      window.location.href = APK[pick];
    }

    // تشغيل
    setEnvPill();
    fillDeviceInfo();
    bindLinks();

    el("smartBtn").addEventListener("click", smartDownload);

    // ✅ جلب أحدث إصدار + عدد التنزيلات
    loadLatestRelease();
  </script>
</body>
</html>
