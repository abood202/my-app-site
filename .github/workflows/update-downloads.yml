name: Update download counts

on:
  schedule:
    - cron: "0 * * * *"   # كل ساعة
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch download counts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DATA=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/abood202/my-app-site/releases/latest)

          TOTAL=$(echo "$DATA" | jq '[.assets[] | select(.name | endswith(".apk")) | .download_count] | add')

          mkdir -p data
          echo "{
            \"video-manager\": {
              \"total\": ${TOTAL:-0},
              \"tag\": \"$(echo "$DATA" | jq -r .tag_name)\",
              \"updated_at\": \"$(date -u +"%Y-%m-%d %H:%M UTC")\"
            }
          }" > data/downloads.json

      - name: Commit & push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/downloads.json
          git commit -m "Update download counts" || exit 0
          git push
