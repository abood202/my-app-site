name: Update downloads counter

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # كل ساعة (يمكن تغييرها)

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch latest release downloads (APK)
        env:
          OWNER: abood202
          REPO: my-app-site
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          API="https://api.github.com/repos/${OWNER}/${REPO}/releases/latest"

          # اجلب بيانات آخر Release (مصادق عبر GITHUB_TOKEN)
          json="$(curl -sS -H "Authorization: Bearer ${GH_TOKEN}" \
                       -H "Accept: application/vnd.github+json" \
                       "${API}")"

          # استخراج tag_name + إجمالي تنزيلات ملفات apk
          tag="$(echo "$json" | jq -r '.tag_name // ""')"
          total="$(echo "$json" | jq '[.assets[]? | select(.name | ascii_downcase | endswith(".apk")) | (.download_count // 0)] | add // 0')"
          now="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

          mkdir -p data

          cat > data/downloads.json <<EOF
          {
            "video-manager": {
              "total": ${total},
              "tag": "${tag}",
              "updated_at": "${now}"
            }
          }
          EOF

      - name: Commit changes (if any)
        run: |
          if git diff --quiet; then
            echo "No changes."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/downloads.json
          git commit -m "Update downloads.json"
          git push
